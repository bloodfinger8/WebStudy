<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="boardSQL">

<insert id="write" parameterType="board">
insert into board values(seq_board.nextval,#{id},#{name},#{email},#{subject},#{content},seq_board.currval,#{lev},#{step},#{pseq},#{reply},#{hit},sysdate)
</insert>

<select id="writeAll" parameterType="java.util.Map" resultType="board">
select * from 
(select rownum rn, tt.* from 
(select seq,id,name,email,subject,content,ref,lev,step,pseq,reply,hit,to_char(logtime,'YYYY-MM-DD') as logtime 
from board order by ref desc, step asc)tt) 
where rn<![CDATA[>=]]> #{startNum,jdbcType=INTEGER} and rn <![CDATA[<=]]> #{endNum,jdbcType=INTEGER}
<if test="selected == 'all'">
AND (subject like '%'||#{textContent,jdbcType=VARCHAR}||'%' OR content like '%'||#{textContent,jdbcType=VARCHAR}||'%')
</if>
<if test="selected == 'subject'">
AND subject like '%'||#{textContent,jdbcType=VARCHAR}||'%'
</if>
<if test="selected == 'writer'">
AND id like '%'||#{textContent,jdbcType=VARCHAR}||'%'
</if>
</select>

<select id="getTotalA" parameterType="java.util.Map" resultType="java.lang.Integer">
select count(*) from board
<if test="selected == 'all'">
where subject like '%'||#{textContent,jdbcType=VARCHAR}||'%' OR content like '%'||#{textContent,jdbcType=VARCHAR}||'%'
</if>
<if test="selected == 'subject'">
where subject like '%'||#{textContent,jdbcType=VARCHAR}||'%'
</if>
<if test="selected == 'writer'">
where id like '%'||#{textContent,jdbcType=VARCHAR}||'%'
</if>
</select>

<select id="getBoard" parameterType="Integer" resultType="board">
select * from board where seq = #{seq}
</select>

<update id="boardModify" parameterType="java.util.Map">
update board set subject=#{subject},content=#{content},logtime=sysdate where seq=#{seq}
</update>

<update id="boardHit" parameterType="Integer">
update board set hit=hit+1 where seq=#{seq}
</update>

<update id="boardReply1" parameterType="board">
update board set step=step+1 where ref=#{ref} and step>#{step}
</update>

<insert id="boardReply2" parameterType="board">
insert into board values(seq_board.nextval,#{id},#{name},#{email},#{subject},#{content},#{ref},#{lev},#{step},#{pseq},0,0,sysdate)
</insert>

<update id="boardReply3" parameterType="Integer">
update board set reply=reply+1 where seq=#{pseq}
</update>

<update id="boardDelete1" parameterType="Integer">
update board set reply=reply-1
where ref=(select ref from board where seq=#{seq}) and seq=(select pseq from board where seq=#{seq})

</update>

<update id="boardDelete2" parameterType="Integer">
update board set subject = '[원글이 삭제된 답글]'||subject
where ref=(select ref from board where seq=#{seq}) and pseq=(select seq from board where seq=#{seq})
</update>

<delete id="boardDelete3" parameterType="Integer">
delete from board where seq=${seq}
</delete>

</mapper>